#!/usr/bin/make -f
# Run the ABySS paired-end assembler.
# Written by Shaun Jackman <sjackman@bcgsc.ca>.

ifndef lib
$(error missing argument lib)
endif
ifndef k
$(error missing argument k)
endif
ifndef l
$(error missing argument l)
endif
ifndef c
$(error missing argument c)
endif
ifndef n
$(error missing argument n)
endif
#v=-v

all: $(lib)-contigs.fa

clean:
	rm -f *.len *.adj *.pair *.hist *.dist *.path

.PHONY: all clean
.DELETE_ON_ERROR:
.SECONDARY:

# Single-end assembly

%-1.fa: %.fa
	ABYSS $v -k$k -l$l -ssnp.fa -o $@ $^

%.len: %.fa
	awk '/^>/ {getline s; print substr($$1, 2), length(s)}' $< >$@

%.adj: %.fa
	AdjList -k$k $< >$@

# Coverage cutoff

%-2.fa: %-1.fa
	awk '/^>/ { getline s; if ($$3/($$2-$k+1)>=$c) \
		{ print $$0 "\n" s } }' $< >$@

%-3.fa: %-2.fa
	ABYSS -k$k -l$l -e0 -o $@ $^

# Estimate distances between contigs

%.pair %.hist: $(lib).fa %.fa
	KAligner $v -k$k $^ |ParseAligns $v -k$k -h $*.hist \
		|sort -nk2,2 -o $*.pair

%.dist: %.len %.hist %.pair
	DistanceEst $v -k$k -n$n -o $@ $^

# Find overlaps between contigs

%-overlap.fa: %.fa %.adj %.len %.dist
	Overlap $v -k$k -o $@ $^

%-4.fa: %-3.fa %-3-overlap.fa
	ABYSS -k$k -l$l -e0 -o $@ $^

# Paired-end assembly

%.path: %.adj %.len %.dist
	SimpleGraph $v -k$k -o $@ $^

%-contigs.fa: %-4.fa %-4.path
	MergePaths $v -k$k -o $@ $^
