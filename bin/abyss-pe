#!/usr/bin/make -f
# Run the ABySS paired-end assembler.
# Written by Shaun Jackman <sjackman@bcgsc.ca>.

# Integrate with Sun Grid Engine (SGE).
ifdef JOB_NAME
lib?=$(JOB_NAME)
endif
ifdef SGE_TASK_ID
k?=$(SGE_TASK_ID)
endif
ifdef NSLOTS
np?=$(NSLOTS)
endif

mpirun = $(shell which mpirun)

ifdef lib
ext?=.fa
in?=$(addsuffix $(ext), $(lib))
else
lib?=$(basename $(in))
endif
out?=$(notdir $(firstword $(lib)))-contigs.fa

ifndef in
$(error missing argument in)
endif
ifndef k
$(error missing argument k)
endif
ifndef l
$(error missing argument l)
endif
ifndef c
$(error missing argument c)
endif
ifndef n
$(error missing argument n)
endif
s?=100
ifdef np
j?=$(np)
else
j?=1
endif
#v=-v

all: $(out)

clean:
	rm -f *.adj *.pair.gz *.hist *.dist *.path

.PHONY: all clean
.DELETE_ON_ERROR:
.SECONDARY:

# Single-end assembly

%-3.fa: $(in)
ifdef np
	$(mpirun) -np $(np) ABYSS-P $(ABYSS_OPTIONS) $v -k$k -l$l -c$c \
		-s bubbles.fa -o $*-3p.fa $^
	awk '/^>/ { $$1=">" i++ } { print }' $*-3p.fa >$@
	rm -f $*-3p.fa
else
	ABYSS $(ABYSS_OPTIONS) $v -k$k -l$l -c$c -s bubbles.fa -o $@ $^
endif

%.adj: %.fa
	AdjList -k$k $< >$@

# Estimate distances between contigs

%.pair.gz %.hist: %.fa
	KAligner $v -j$j -k$k $(in) $< \
		|ParseAligns $v -k$k -h $*.hist \
		|sort -nk2,2 \
		|gzip >$*.pair.gz

%.dist: %.pair.gz %.adj %.hist
	zcat $< |DistanceEst $v -k$k -s$s -n$n -o $@ $*.adj $*.hist -

# Find overlaps between contigs

%-overlap.fa: %.fa %.adj %.dist
	Overlap $v -k$k -o $@ $^

%-4.fa: %-3.fa %-3-overlap.fa
	cat $^ >$@

# Paired-end assembly

%-4.path: %-4.adj %-3.dist
	SimpleGraph $v -k$k -o $@ $^

ifndef cs

%-contigs.fa: %-4.fa %-4.path
	MergePaths $v -k$k -o $@ $^

else

%-cs.fa: %-4.fa %-4.path
	MergePaths $v -k$k -o $@ $^

%-contigs.fa: %-cs.fa
	KAligner $v --seq -m -j$j -k$k $(in) $< \
		|Consensus $v -o $@ $<

endif
