#!/usr/bin/make -f
# Run the ABySS paired-end assembler.
# Written by Shaun Jackman <sjackman@bcgsc.ca>.

mpirun = $(shell which mpirun)

ifdef lib
ext?=.fa
in?=$(addsuffix $(ext), $(lib))
else
lib?=$(basename $(in))
endif
out?=$(notdir $(firstword $(lib)))-contigs.fa

ifndef in
$(error missing argument in)
endif
ifndef k
$(error missing argument k)
endif
ifndef l
$(error missing argument l)
endif
ifndef c
$(error missing argument c)
endif
ifndef n
$(error missing argument n)
endif
s?=100
ifdef np
j?=$(np)
else
j?=1
endif
#v=-v

all: $(out)

clean:
	rm -f *.len *.adj *.pair *.hist *.dist *.path

.PHONY: all clean
.DELETE_ON_ERROR:
.SECONDARY:

# Single-end assembly

%-1.fa: $(in)
ifdef np
	$(mpirun) -np $(np) ABYSS-P $v -k$k -l$l \
		-s bubbles.fa.fa -o $@ $^
else
	ABYSS $v -k$k -l$l -s bubbles.fa.fa -o $@ $^
endif

%.len: %.fa
	awk '/^>/ {getline s; print substr($$1, 2), length(s)}' $< >$@

%.adj: %.fa
	AdjList -k$k $< >$@

# Coverage cutoff

%-3.fa: %-1.fa
	awk '/^>/ { getline s; if ($$3/($$2-$k+1)>=$c) \
		{ print $$0 "\n" s } }' $< \
		|ABYSS $v -k$k -l$l -e0 -o $@ -

# Estimate distances between contigs

%.pair.gz %.hist: %.fa
	KAligner $v -j$j -k$k $(in) $< \
		|ParseAligns $v -k$k -h $*.hist \
		|sort -nk2,2 \
		|gzip >$*.pair.gz

%.dist: %.pair.gz %.len %.hist
	zcat $< |DistanceEst $v -k$k -s$s -n$n -o $@ $*.len $*.hist -

# Find overlaps between contigs

%-overlap.fa: %.fa %.adj %.len %.dist
	Overlap $v -k$k -o $@ $^

%-4.fa: %-3.fa %-3-overlap.fa
	ABYSS $v -k$k -l$l -e0 -o $@ $^

# Paired-end assembly

%.path: %.adj %.len %.dist
	SimpleGraph $v -k$k -o $@ $^

%-contigs.fa: %-4.fa %-4.path
	MergePaths $v -k$k -o $@ $^
